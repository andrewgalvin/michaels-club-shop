<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Michael's Club Shop - Premium Golf Equipment</title>
    <meta
      name="description"
      content="Premium golf clubs and equipment. Browse drivers, irons, wedges, putters and more from top brands."
    />
    <meta
      name="keywords"
      content="golf clubs, golf equipment, drivers, irons, wedges, putters, TaylorMade, Callaway, Titleist, Ping"
    />

    <!-- Tailwind via CDN for quick GitHub Pages setup -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                900: "#1e3a8a",
              },
            },
          },
        },
      };
    </script>
    <style>
      /* Enhanced styling */
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .modal-open {
        overflow: hidden;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .admin-hidden {
        display: none !important;
      }
      .admin-visible {
        display: block !important;
      }
    </style>
  </head>
  <body class="bg-stone-50 text-stone-900">
    <!-- Admin Access Trigger (Hidden) -->
    <div id="adminTrigger" class="fixed bottom-4 right-4 z-50">
      <button
        id="adminBtn"
        class="size-12 bg-primary-600 text-white rounded-full shadow-lg hover:bg-primary-700 transition-colors opacity-0 hover:opacity-100"
      >
        ⚙️
      </button>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="fixed inset-0 z-50 bg-black/50 hidden">
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden"
        >
          <div
            class="flex items-center justify-between p-6 border-b border-stone-200"
          >
            <h2 class="text-xl font-semibold">Product Management</h2>
            <button id="closeAdmin" class="text-stone-500 hover:text-stone-700">
              ✕
            </button>
          </div>
          <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Add Product Form -->
              <div>
                <h3 class="text-lg font-medium mb-4">Add New Product</h3>
                <form id="addProductForm" class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Title *</label
                    >
                    <input
                      type="text"
                      name="title"
                      required
                      class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    />
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-1"
                        >Brand *</label
                      >
                      <input
                        type="text"
                        name="brand"
                        required
                        class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1"
                        >Category *</label
                      >
                      <select
                        name="category"
                        required
                        class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      >
                        <option value="">Select...</option>
                        <option value="Driver">Driver</option>
                        <option value="Fairway Wood">Fairway Wood</option>
                        <option value="Hybrid">Hybrid</option>
                        <option value="Iron">Iron</option>
                        <option value="Wedge">Wedge</option>
                        <option value="Putter">Putter</option>
                        <option value="Utility">Utility</option>
                        <option value="Accessory">Accessory</option>
                      </select>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-1"
                        >Price *</label
                      >
                      <input
                        type="number"
                        name="price"
                        step="0.01"
                        min="0"
                        required
                        class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      />
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-1"
                        >Condition *</label
                      >
                      <select
                        name="condition"
                        required
                        class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      >
                        <option value="">Select...</option>
                        <option value="New">New</option>
                        <option value="Like New">Like New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                      </select>
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Description</label
                    >
                    <textarea
                      name="description"
                      rows="3"
                      class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Specifications (JSON)</label
                    >
                    <textarea
                      name="specs"
                      rows="3"
                      placeholder='{"loft": "10.5°", "flex": "Stiff", "shaft": "Fujikura Ventus"}'
                      class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500 font-mono text-sm"
                    ></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-1"
                      >Image URLs (one per line)</label
                    >
                    <textarea
                      name="images"
                      rows="3"
                      placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"
                      class="w-full rounded-lg border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    ></textarea>
                  </div>
                  <div class="flex gap-3">
                    <button
                      type="submit"
                      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
                    >
                      Add Product
                    </button>
                    <button
                      type="button"
                      id="exportProducts"
                      class="px-4 py-2 border border-stone-300 rounded-lg hover:bg-stone-100 transition-colors"
                    >
                      Export JSON
                    </button>
                  </div>
                </form>
              </div>

              <!-- Product List -->
              <div>
                <h3 class="text-lg font-medium mb-4">Current Products</h3>
                <div
                  id="adminProductList"
                  class="space-y-3 max-h-96 overflow-y-auto"
                >
                  <!-- Products will be listed here -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <header
      class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-stone-200"
    >
      <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
        <div
          class="size-9 rounded-xl bg-primary-600 text-white grid place-content-center font-bold"
        >
          CS
        </div>
        <h1 class="text-xl font-semibold">Michael's Club Shop</h1>
        <span class="ml-auto text-xs text-stone-500"
          >Premium Golf Equipment</span
        >
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-6">
      <!-- Enhanced Controls -->
      <section
        class="bg-white border border-stone-200 rounded-2xl p-4 shadow-sm"
      >
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-3">
          <div class="lg:col-span-2">
            <label class="block text-xs font-medium mb-1">Search</label>
            <input
              id="searchInput"
              type="search"
              placeholder="Search clubs, brand, model…"
              class="w-full rounded-xl border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            />
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Category</label>
            <select
              id="categorySelect"
              class="w-full rounded-xl border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Brand</label>
            <select
              id="brandSelect"
              class="w-full rounded-xl border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Condition</label>
            <select
              id="conditionSelect"
              class="w-full rounded-xl border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">Any</option>
              <option>New</option>
              <option>Like New</option>
              <option>Good</option>
              <option>Fair</option>
              <option>Poor</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1">Sort</label>
            <select
              id="sortSelect"
              class="w-full rounded-xl border-stone-300 focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="priceAsc">Price: Low → High</option>
              <option value="priceDesc">Price: High → Low</option>
              <option value="nameAsc">Name: A → Z</option>
              <option value="nameDesc">Name: Z → A</option>
              <option value="newest">Newest First</option>
            </select>
          </div>
        </div>
        <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
          <button
            id="resetBtn"
            class="px-3 py-1.5 rounded-lg border border-stone-300 hover:bg-stone-100 transition-colors"
          >
            Reset
          </button>
          <span id="stats" class="ml-auto text-stone-500"></span>
        </div>
      </section>

      <!-- Enhanced Grid -->
      <section class="mt-6">
        <div
          id="grid"
          class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"
        ></div>
      </section>
    </main>

    <!-- Enhanced Modal -->
    <div id="modal" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black/60" data-close></div>
      <div class="absolute inset-0 flex items-center justify-center p-4">
        <div
          class="relative w-full max-w-4xl bg-white rounded-2xl overflow-hidden shadow-xl"
        >
          <button
            class="absolute top-4 right-4 size-10 rounded-full bg-white/90 border border-stone-200 hover:bg-white transition-colors z-10"
            data-close
            aria-label="Close"
          >
            ✕
          </button>
          <div class="p-6">
            <div
              id="modalContent"
              class="grid grid-cols-1 lg:grid-cols-2 gap-6"
            >
              <!-- Images will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div
      id="loading"
      class="fixed inset-0 z-50 bg-white/80 flex items-center justify-center hidden"
    >
      <div
        class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"
      ></div>
    </div>

    <script>
      // ===== CONFIGURATION =====
      const CONFIG = {
        // Encrypted admin key - not visible in source
        ADMIN_KEY_HASH:
          "4529c0aab1fc50db36eabeab18053cd45345def0f5de9ee489c4aab6324c7746",
        STORAGE_KEY: "club_shop_products",
        IMAGE_PLACEHOLDER:
          "https://placehold.co/600x400/stone-200/stone-600?text=No+Image",
      };

      // ===== STATE MANAGEMENT =====
      let PRODUCTS = [];
      let isAdmin = false;

      // ===== DOM ELEMENTS =====
      const els = {
        // Main elements
        grid: document.getElementById("grid"),
        stats: document.getElementById("stats"),
        search: document.getElementById("searchInput"),
        category: document.getElementById("categorySelect"),
        brand: document.getElementById("brandSelect"),
        condition: document.getElementById("conditionSelect"),
        sort: document.getElementById("sortSelect"),
        resetBtn: document.getElementById("resetBtn"),
        modal: document.getElementById("modal"),
        modalContent: document.getElementById("modalContent"),
        loading: document.getElementById("loading"),

        // Admin elements
        adminTrigger: document.getElementById("adminTrigger"),
        adminBtn: document.getElementById("adminBtn"),
        adminPanel: document.getElementById("adminPanel"),
        closeAdmin: document.getElementById("closeAdmin"),
        addProductForm: document.getElementById("addProductForm"),
        adminProductList: document.getElementById("adminProductList"),
        exportProducts: document.getElementById("exportProducts"),
      };

      // ===== UTILITY FUNCTIONS =====
      function escapeHtml(s) {
        return String(s).replace(
          /[&<>"']/g,
          (c) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[c])
        );
      }

      function formatPrice(price) {
        return new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
        }).format(price);
      }

      function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function showLoading() {
        els.loading.classList.remove("hidden");
      }

      function hideLoading() {
        els.loading.classList.add("hidden");
      }

      // ===== PRODUCT MANAGEMENT =====
      async function loadProducts() {
        showLoading();
        try {
          // Try to load from products.json first
          const res = await fetch("products.json", { cache: "no-store" });
          if (res.ok) {
            const json = await res.json();
            if (Array.isArray(json)) {
              PRODUCTS = json;
              saveProductsToStorage();
              return;
            }
          }

          // Fallback to sample data
          PRODUCTS = getSampleProducts();
          saveProductsToStorage();
        } catch (e) {
          console.warn("Failed to load products.json, using sample data:", e);
          PRODUCTS = getSampleProducts();
          saveProductsToStorage();
        } finally {
          hideLoading();
        }
      }

      function getSampleProducts() {
        return [
          {
            id: generateId(),
            title: "TaylorMade Stealth Driver 10.5°",
            brand: "TaylorMade",
            category: "Driver",
            condition: "Like New",
            price: 389.99,
            images: [
              "https://images.unsplash.com/photo-1593111774240-d529f12cf4bb?w=600&h=400&fit=crop",
              "https://images.unsplash.com/photo-1593111774240-d529f12cf4bb?w=600&h=400&fit=crop",
            ],
            description: "Carbon face, mid-high launch, adjustable loft.",
            specs: { loft: "10.5°", flex: "Stiff", shaft: "Fujikura Ventus" },
            createdAt: new Date().toISOString(),
          },
          {
            id: generateId(),
            title: "Callaway Apex 7-Iron (2021)",
            brand: "Callaway",
            category: "Iron",
            condition: "Good",
            price: 79.0,
            images: [
              "https://images.unsplash.com/photo-1593111774240-d529f12cf4bb?w=600&h=400&fit=crop",
            ],
            description: "Forged feel, great distance and control.",
            specs: { loft: "34°", flex: "Regular", material: "Forged Steel" },
            createdAt: new Date().toISOString(),
          },
          {
            id: generateId(),
            title: "Titleist Vokey SM9 Wedge 56°",
            brand: "Titleist",
            category: "Wedge",
            condition: "New",
            price: 159.0,
            images: [
              "https://images.unsplash.com/photo-1593111774240-d529f12cf4bb?w=600&h=400&fit=crop",
            ],
            description: "Classic spin with versatile grind.",
            specs: { loft: "56°", bounce: "10°", grind: "S Grind" },
            createdAt: new Date().toISOString(),
          },
        ];
      }

      function saveProductsToStorage() {
        try {
          localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(PRODUCTS));
        } catch (e) {
          console.warn("Failed to save to localStorage:", e);
        }
      }

      function loadProductsFromStorage() {
        try {
          const stored = localStorage.getItem(CONFIG.STORAGE_KEY);
          if (stored) {
            PRODUCTS = JSON.parse(stored);
            return true;
          }
        } catch (e) {
          console.warn("Failed to load from localStorage:", e);
        }
        return false;
      }

      function addProduct(productData) {
        const product = {
          id: generateId(),
          ...productData,
          createdAt: new Date().toISOString(),
        };

        // Parse specs if provided as string
        if (typeof product.specs === "string" && product.specs.trim()) {
          try {
            product.specs = JSON.parse(product.specs);
          } catch (e) {
            product.specs = {};
          }
        }

        // Parse images if provided as string
        if (typeof product.images === "string" && product.images.trim()) {
          product.images = product.images
            .split("\n")
            .filter((url) => url.trim());
        }

        PRODUCTS.unshift(product);
        saveProductsToStorage();
        buildFacets(PRODUCTS);
        render();
        renderAdminProductList();

        return product;
      }

      function deleteProduct(productId) {
        PRODUCTS = PRODUCTS.filter((p) => p.id !== productId);
        saveProductsToStorage();
        buildFacets(PRODUCTS);
        render();
        renderAdminProductList();
      }

      // ===== FACETS & FILTERING =====
      function buildFacets(items) {
        const cats = Array.from(
          new Set(items.map((p) => p.category).filter(Boolean))
        ).sort();
        const brands = Array.from(
          new Set(items.map((p) => p.brand).filter(Boolean))
        ).sort();

        // Clear existing options
        els.category.innerHTML = '<option value="">All</option>';
        els.brand.innerHTML = '<option value="">All</option>';

        // Add new options
        for (const c of cats) {
          const o = document.createElement("option");
          o.value = c;
          o.textContent = c;
          els.category.appendChild(o);
        }
        for (const b of brands) {
          const o = document.createElement("option");
          o.value = b;
          o.textContent = b;
          els.brand.appendChild(o);
        }
      }

      function getFilters() {
        return {
          q: els.search.value.trim().toLowerCase(),
          category: els.category.value,
          brand: els.brand.value,
          condition: els.condition.value,
          sort: els.sort.value,
        };
      }

      function setFilters(state) {
        els.search.value = state.q ?? "";
        els.category.value = state.category ?? "";
        els.brand.value = state.brand ?? "";
        els.condition.value = state.condition ?? "";
        els.sort.value = state.sort ?? "priceAsc";
      }

      function filterAndSort(items) {
        const f = getFilters();
        let out = items.filter((p) => {
          const term = f.q;
          const matchesTerm =
            !term ||
            [p.title, p.brand, p.category, p.description].some((x) =>
              (x || "").toLowerCase().includes(term)
            );
          const matchesCat = !f.category || p.category === f.category;
          const matchesBrand = !f.brand || p.brand === f.brand;
          const matchesCond = !f.condition || p.condition === f.condition;
          return matchesTerm && matchesCat && matchesBrand && matchesCond;
        });

        switch (f.sort) {
          case "priceAsc":
            out.sort((a, b) => a.price - b.price);
            break;
          case "priceDesc":
            out.sort((a, b) => b.price - a.price);
            break;
          case "nameAsc":
            out.sort((a, b) => a.title.localeCompare(b.title));
            break;
          case "nameDesc":
            out.sort((a, b) => b.title.localeCompare(a.title));
            break;
          case "newest":
            out.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            break;
        }
        return out;
      }

      // ===== RENDERING =====
      function render() {
        const filtered = filterAndSort(PRODUCTS);
        saveToURL();
        els.stats.textContent = `${filtered.length} item${
          filtered.length === 1 ? "" : "s"
        } shown`;
        els.grid.innerHTML = "";

        if (filtered.length === 0) {
          els.grid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <div class="text-stone-400 text-lg">No products found</div>
              <div class="text-stone-500 text-sm mt-2">Try adjusting your filters</div>
            </div>
          `;
          return;
        }

        for (const p of filtered) {
          els.grid.appendChild(renderCard(p));
        }
      }

      function renderCard(p) {
        const img =
          p.images && p.images[0] ? p.images[0] : CONFIG.IMAGE_PLACEHOLDER;
        const count = (p.images || []).length;
        const el = document.createElement("article");
        el.className =
          "bg-white rounded-2xl border border-stone-200 overflow-hidden shadow-sm flex flex-col hover:shadow-md transition-shadow fade-in";
        el.innerHTML = `
          <div class="aspect-[4/3] bg-stone-100 overflow-hidden relative group">
            <img src="${img}" alt="${escapeHtml(
          p.title
        )}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" loading="lazy"/>
            ${
              count > 1
                ? `<div class="absolute top-2 right-2 bg-black/70 text-white text-xs px-2 py-1 rounded-full">${count} photos</div>`
                : ""
            }
          </div>
          <div class="p-4 flex-1 flex flex-col gap-2">
            <h3 class="font-semibold leading-snug line-clamp-2">${escapeHtml(
              p.title
            )}</h3>
            <div class="text-sm text-stone-600">${escapeHtml(
              p.brand || ""
            )} • ${escapeHtml(p.category || "")}</div>
            ${
              p.description
                ? `<div class="text-sm text-stone-500 line-clamp-2">${escapeHtml(
                    p.description
                  )}</div>`
                : ""
            }
            <div class="mt-auto flex items-center justify-between">
              <div class="text-lg font-bold text-primary-600">${formatPrice(
                p.price
              )}</div>
              <span class="text-xs px-2 py-1 rounded-full border border-stone-300 bg-stone-50">${escapeHtml(
                p.condition || "—"
              )}</span>
            </div>
            <div class="flex gap-2 mt-2">
              <button class="flex-1 px-3 py-1.5 rounded-lg border border-stone-300 hover:bg-stone-100 transition-colors" data-photos>
                ${count > 0 ? `Photos (${count})` : "View Details"}
              </button>
              <a class="flex-1 px-3 py-1.5 rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition-colors text-center" href="#" aria-label="Buy ${escapeHtml(
                p.title
              )}">
                Buy
              </a>
            </div>
          </div>`;

        const btn = el.querySelector("[data-photos]");
        btn.addEventListener("click", () => openModal(p));
        el.querySelector("img").addEventListener("click", () => openModal(p));
        return el;
      }

      function renderAdminProductList() {
        els.adminProductList.innerHTML = "";

        if (PRODUCTS.length === 0) {
          els.adminProductList.innerHTML =
            '<div class="text-stone-500 text-center py-4">No products yet</div>';
          return;
        }

        PRODUCTS.forEach((product) => {
          const el = document.createElement("div");
          el.className = "border border-stone-200 rounded-lg p-3 bg-stone-50";
          el.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-sm truncate">${escapeHtml(
                  product.title
                )}</h4>
                <div class="text-xs text-stone-600">${escapeHtml(
                  product.brand
                )} • ${formatPrice(product.price)}</div>
              </div>
              <button class="text-red-500 hover:text-red-700 text-sm" data-delete="${
                product.id
              }">Delete</button>
            </div>
          `;

          el.querySelector(`[data-delete="${product.id}"]`).addEventListener(
            "click",
            () => {
              if (confirm("Are you sure you want to delete this product?")) {
                deleteProduct(product.id);
              }
            }
          );

          els.adminProductList.appendChild(el);
        });
      }

      // ===== MODAL =====
      function openModal(product) {
        document.body.classList.add("modal-open");
        els.modal.classList.remove("hidden");

        const imgs = product.images || [];
        const specs = product.specs || {};

        let imagesHtml = "";
        if (imgs.length === 0) {
          imagesHtml = `
            <div class="aspect-video bg-stone-100 rounded-xl flex items-center justify-center">
              <div class="text-stone-400 text-center">
                <div class="text-2xl mb-2">📷</div>
                <div>No images available</div>
              </div>
            </div>
          `;
        } else {
          imagesHtml = `
            <div class="aspect-video bg-stone-100 rounded-xl overflow-hidden relative">
              <img id="modalMainImg" src="${imgs[0]}" alt="${escapeHtml(
            product.title
          )}" class="w-full h-full object-contain"/>
              ${
                imgs.length > 1
                  ? `
                <div class="absolute bottom-3 left-3 right-3 flex gap-2 overflow-x-auto">
                  ${imgs
                    .map(
                      (img, idx) => `
                    <button class="modal-thumb flex-shrink-0 size-16 rounded-lg overflow-hidden border-2 ${
                      idx === 0 ? "border-primary-500" : "border-white"
                    }" data-img="${img}">
                      <img src="${img}" alt="" class="w-full h-full object-cover"/>
                    </button>
                  `
                    )
                    .join("")}
                </div>
              `
                  : ""
              }
            </div>
          `;
        }

        const specsHtml =
          Object.keys(specs).length > 0
            ? `
          <div class="mt-4">
            <h4 class="font-medium mb-2">Specifications</h4>
            <div class="grid grid-cols-2 gap-2 text-sm">
              ${Object.entries(specs)
                .map(
                  ([key, value]) => `
                <div class="flex justify-between">
                  <span class="text-stone-600 capitalize">${key}:</span>
                  <span class="font-medium">${escapeHtml(value)}</span>
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `
            : "";

        els.modalContent.innerHTML = `
          <div class="space-y-4">
            ${imagesHtml}
          </div>
          <div class="space-y-4">
            <div>
              <h2 class="text-xl font-semibold mb-2">${escapeHtml(
                product.title
              )}</h2>
              <div class="text-stone-600 mb-2">${escapeHtml(
                product.brand
              )} • ${escapeHtml(product.category)}</div>
              <div class="text-2xl font-bold text-primary-600 mb-3">${formatPrice(
                product.price
              )}</div>
              <span class="inline-block px-3 py-1 rounded-full border border-stone-300 bg-stone-50 text-sm">${escapeHtml(
                product.condition
              )}</span>
            </div>
            ${
              product.description
                ? `<p class="text-stone-700">${escapeHtml(
                    product.description
                  )}</p>`
                : ""
            }
            ${specsHtml}
            <div class="pt-4">
              <a href="#" class="block w-full bg-primary-600 text-white text-center py-3 rounded-lg hover:bg-primary-700 transition-colors">
                Contact About This Item
              </a>
            </div>
          </div>
        `;

        // Add thumbnail click handlers
        els.modalContent.querySelectorAll(".modal-thumb").forEach((thumb) => {
          thumb.addEventListener("click", () => {
            const img = thumb.dataset.img;
            els.modalContent.querySelector("#modalMainImg").src = img;
            els.modalContent
              .querySelectorAll(".modal-thumb")
              .forEach((t) =>
                t.classList.remove("border-primary-500", "border-white")
              );
            thumb.classList.add("border-primary-500");
          });
        });
      }

      function closeModal() {
        els.modal.classList.add("hidden");
        document.body.classList.remove("modal-open");
      }

      // ===== URL MANAGEMENT =====
      function saveToURL() {
        const f = getFilters();
        const params = new URLSearchParams();
        if (f.q) params.set("q", f.q);
        if (f.category) params.set("cat", f.category);
        if (f.brand) params.set("brand", f.brand);
        if (f.condition) params.set("cond", f.condition);
        if (f.sort && f.sort !== "priceAsc") params.set("sort", f.sort);
        const newHash = params.toString();
        history.replaceState(
          null,
          "",
          newHash ? "#" + newHash : location.pathname + location.search
        );
      }

      function applyFromURL() {
        const hash = location.hash.startsWith("#")
          ? location.hash.slice(1)
          : "";
        const params = new URLSearchParams(hash);
        setFilters({
          q: params.get("q") || "",
          category: params.get("cat") || "",
          brand: params.get("brand") || "",
          condition: params.get("cond") || "",
          sort: params.get("sort") || "priceAsc",
        });
      }

      // ===== ADMIN FUNCTIONS =====
      async function hashString(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      async function checkAdminAccess() {
        const urlParams = new URLSearchParams(window.location.search);
        const adminKey = urlParams.get("admin");
        const keyParam = urlParams.get("key");

        // Check if admin key matches (either from 'admin' or 'key' parameter)
        if (adminKey || keyParam) {
          const inputKey = adminKey || keyParam;
          const hashedInput = await hashString(inputKey);

          if (hashedInput === CONFIG.ADMIN_KEY_HASH) {
            isAdmin = true;
            els.adminTrigger.classList.remove("hidden");
            els.adminBtn.classList.remove("opacity-0");
            return true;
          }
        }

        // Check if admin was previously activated
        if (localStorage.getItem("club_shop_admin") === "true") {
          isAdmin = true;
          els.adminTrigger.classList.remove("hidden");
          els.adminBtn.classList.remove("opacity-0");
          return true;
        }

        return false;
      }

      function activateAdmin() {
        isAdmin = true;
        localStorage.setItem("club_shop_admin", "true");
        els.adminTrigger.classList.remove("hidden");
        els.adminBtn.classList.remove("opacity-0");
      }

      function deactivateAdmin() {
        isAdmin = false;
        localStorage.removeItem("club_shop_admin");
        els.adminTrigger.classList.add("hidden");
        els.adminBtn.classList.add("opacity-0");
        els.adminPanel.classList.add("hidden");
      }

      // ===== EVENT HANDLERS =====
      function setupEventHandlers() {
        // Search and filtering
        const debounced = (fn, ms = 250) => {
          let t;
          return (...a) => {
            clearTimeout(t);
            t = setTimeout(() => fn(...a), ms);
          };
        };
        els.search.addEventListener("input", debounced(render, 200));
        els.category.addEventListener("change", render);
        els.brand.addEventListener("change", render);
        els.condition.addEventListener("change", render);
        els.sort.addEventListener("change", render);
        els.resetBtn.addEventListener("click", () => {
          setFilters({});
          render();
        });

        // Modal
        els.modal.addEventListener("click", (e) => {
          if (e.target.hasAttribute("data-close")) closeModal();
        });
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") closeModal();
        });

        // Admin
        els.adminBtn.addEventListener("click", () => {
          els.adminPanel.classList.remove("hidden");
          renderAdminProductList();
        });

        els.closeAdmin.addEventListener("click", () => {
          els.adminPanel.classList.add("hidden");
        });

        els.adminPanel.addEventListener("click", (e) => {
          if (e.target === els.adminPanel) {
            els.adminPanel.classList.add("hidden");
          }
        });

        // Add product form
        els.addProductForm.addEventListener("submit", (e) => {
          e.preventDefault();
          const formData = new FormData(els.addProductForm);
          const productData = {
            title: formData.get("title"),
            brand: formData.get("brand"),
            category: formData.get("category"),
            price: parseFloat(formData.get("price")),
            condition: formData.get("condition"),
            description: formData.get("description"),
            specs: formData.get("specs"),
            images: formData.get("images"),
          };

          addProduct(productData);
          els.addProductForm.reset();

          // Show success message
          const btn = els.addProductForm.querySelector('button[type="submit"]');
          const originalText = btn.textContent;
          btn.textContent = "Added!";
          btn.classList.add("bg-green-600");
          setTimeout(() => {
            btn.textContent = originalText;
            btn.classList.remove("bg-green-600");
          }, 2000);
        });

        // Export products
        els.exportProducts.addEventListener("click", () => {
          const dataStr = JSON.stringify(PRODUCTS, null, 2);
          const dataBlob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "products.json";
          link.click();
          URL.revokeObjectURL(url);
        });

        // Keyboard shortcuts for admin
        window.addEventListener("keydown", (e) => {
          if (e.ctrlKey && e.key === "k") {
            e.preventDefault();
            if (isAdmin) {
              els.adminPanel.classList.toggle("hidden");
              if (!els.adminPanel.classList.contains("hidden")) {
                renderAdminProductList();
              }
            }
          }
        });
      }

      // ===== INITIALIZATION =====
      async function init() {
        setupEventHandlers();
        await checkAdminAccess();

        // Try to load from storage first for faster initial load
        if (!loadProductsFromStorage()) {
          await loadProducts();
        } else {
          // Still try to load from server in background
          loadProducts();
        }

        buildFacets(PRODUCTS);
        applyFromURL();
        render();
      }

      // Start the app
      init();
    </script>
  </body>
</html>
